(function(){var root=this,dw={};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=dw}exports.dw=dw}else{window.dw=dw}dw.dataset=function(columns,opts){var columnsByName={};_.each(columns,function(col){var origColName=col.name(),colName=origColName,appendix=1;while(columnsByName.hasOwnProperty(colName)){colName=origColName+"."+appendix++}if(colName!=origColName)col.name(colName);columnsByName[colName]=col});opts=_.extend(opts,{firstColumnAsLabel:true});var dataset={columns:function(){return columns},column:function(x){if(_.isString(x)){if(columnsByName[x]!==undefined)return columnsByName[x];throw'No column found with that name: "'+x+'"'}if(columns[x]!==undefined)return columns[x];throw"No series found with that index: "+x},numColumns:function(){return columns.length},numRows:function(){return columns[0].length},series:function(x){if(x!==undefined){return dataset.column(x)}return dataset.columns()},hasRowNames:function(){return opts.firstRowAsLabel},eachSeries:function(func){_.each(columns,func)},eachRow:function(func){var i;for(i=0;i<dataset.numRows();i++){func(i)}},rowNames:function(){return columns[0].raw()},rowName:function(i){if(!me.hasRowNames())return"";var k=dataset.numRows;return columns[0].raw()[(i+k)%k]},rowNameLabel:function(){return columns[0].name()},filterRows:function(rows){_.each(columns,function(col){if(rows)col.filterRows(rows);else col.filterRows()})},filterSeries:function(ignore){columns=columns.filter(function(c){return!ignore[c.name()]})},isTimeSeries:function(){return this.__rowDates!==undefined},rowDate:function(i){if(i<0)i+=this.__rowDates.length;return this.__rowDates[i]},rowDates:function(){return this.__rowDates.slice(0)},minMax:function(){var minmax=[Number.MAX_VALUE,-Number.MAX_VALUE];this.eachSeries(function(s){minmax[0]=Math.min(minmax[0],s.min);minmax[1]=Math.max(minmax[1],s.max)});return minmax}};return dataset};dw.column=function(name,rows,type){function guessType(){if(_.every(rows,_.isNumber))return dw.column.types.number();if(_.every(rows,_.isDate))return dw.column.types.date();var types=[dw.column.types.date(rows.slice(0,20)),dw.column.types.number(rows.slice(0,20)),dw.column.types.text()],type,k=rows.length,tolerance=.1;_.each(rows,function(val){_.each(types,function(t){t.parse(val)})});_.every(types,function(t){if(t.errors()/k<tolerance)type=t;return!type});return type}type=type?dw.column.types[type](rows.slice(0,50)):guessType();var range,total,origRows=rows.slice(0);var column={name:function(){if(arguments.length){name=arguments[0];return column}return name},length:rows.length,val:function(i){return type.parse(rows[i])},each:function(f){for(i=0;i<rows.length;i++){f(column.val(i),i)}},raw:function(){return rows},type:function(){return type.name()},range:function(){if(!type.toNum)return false;if(!range){range=[Number.MAX_VALUE,-Number.MAX_VALUE];column.each(function(v){v=type.toNum(v);if(v<range[0])range[0]=v;if(v>range[1])range[1]=v});range[0]=type.fromNum(range[0]);range[1]=type.fromNum(range[1])}return range},total:function(){if(!type.toNum)return false;if(!total){total=0;column.each(function(v){total+=type.toNum(v)});total=type.fromNum(total)}return total},filterRows:function(r){rows=[];if(arguments.length){_.each(r,function(i){rows.push(origRows[i])})}else{rows=origRows.slice(0)}column.length=rows.length;range=total=false;return column},toString:function(){return name+" ("+type.name()+")"}};return column};dw.column.types={};dw.column.types.text=function(){return{parse:function(v){return v},errors:function(){return 0},name:function(){return"text"}}};dw.column.types.number=function(sample){var format,errors=0,knownFormats={"-.":/^ *-?[0-9]*(\.[0-9]+)? *$/,"-,":/^ *-?[0-9]*(,[0-9]+)? *$/,",.":/^ *-?[0-9]{1,3}(,[0-9]{3})*(\.[0-9]+)? *$/,".,":/^ *-?[0-9]{1,3}(\.[0-9]{3})*(,[0-9]+)? *$/," .":/^ *-?[0-9]{1,3}( [0-9]{3})*(\.[0-9]+)? *$/," ,":/^ *-?[0-9]{1,3}( [0-9]{3})*(,[0-9]+)? *$/," .":/^ *-?[0-9]{1,3}( [0-9]{3})*(\.[0-9]+)? *$/," ,":/^ *-?[0-9]{1,3}( [0-9]{3})*(,[0-9]+)? *$/};var matches={},bestMatch=["-.",0];sample=sample||[];_.each(sample,function(n){_.each(knownFormats,function(regex,fmt){if(matches[fmt]===undefined)matches[fmt]=0;if(regex.test(n)){matches[fmt]+=1;if(matches[fmt]>bestMatch[1]){bestMatch[0]=fmt;bestMatch[1]=matches[fmt]}}})});format=bestMatch[0];var type={parse:function(raw){if(_.isNumber(raw))return raw;var number=raw;if(format[0]!="-"){number=number.replace(format[0],"")}if(format[1]!="."){number=number.replace(format[1],".")}number=Number(number);if(isNaN(number)){errors++;return raw}return number},toNum:function(i){return i},fromNum:function(i){return i},errors:function(){return errors},name:function(){return"number"}};return type};dw.column.types.date=function(sample){var format,errors=0,matches={},bestMatch=["",0],knownFormats={YYYY:/^ *([12][0-9]{3}) *$/,"YYYY-H":/^ *([12][0-9]{3})[ \-\/]?H([12]) *$/,"H-YYYY":/^ *H([12])[ \-\/]([12][0-9]{3}) *$/,"YYYY-Q":/^ *([12][0-9]{3})[ \-\/]?Q([1234]) *$/,"Q-YYYY":/^ *Q([1234])[ \-\/]([12][0-9]{3}) *$/,"YYYY-M":/^ *([12][0-9]{3}) ?[ -\/\.](0?[1-9]|1[0-2]) *$/,"M-YYYY":/^ *(0?[1-9]|1[0-2]) ?[ -\/\.]([12][0-9]{3}) *$/,"MM/DD/YYYY":/^ *(0?[1-9]|1[0-2])([-\/] ?)(0?[1-9]|[1-2][0-9]|3[01])\2([12][0-9]{3})(?: (0?[0-9]|1[0-9]|2[0-3]):([0-5][0-9])(?::([0-5][0-9]))?)? *$/,"DD.MM.YYYY":/^ *(0?[1-9]|[1-2][0-9]|3[01])([-\.\/ ?])(0?[1-9]|1[0-2])\2([12][0-9]{3})(?: (0?[0-9]|1[0-9]|2[0-3]):([0-5][0-9])(?::([0-5][0-9]))?)? *$/,"YYYY-MM-DD":/^ *([12][0-9]{3})([-\/\. ?])(0?[1-9]|1[0-2])\2(0?[1-9]|[1-2][0-9]|3[01])(?: (0?[0-9]|1[0-9]|2[0-3]):([0-5][0-9])(?::([0-5][0-9]))?)? *$/};sample=sample||[];_.each(sample,function(n){_.each(knownFormats,function(regex,fmt){if(matches[fmt]===undefined)matches[fmt]=0;if(regex.test(n)){matches[fmt]+=1;if(matches[fmt]>bestMatch[1]){bestMatch[0]=fmt;bestMatch[1]=matches[fmt]}}})});format=bestMatch[0];var type={parse:function(raw){if(_.isDate(raw))return raw;if(format===false||!_.isString(raw)){errors++;return raw}var regex=knownFormats[format],m=raw.match(regex);if(!m){errors++;console.log("err",raw,regex);return raw}switch(format){case"YYYY":return new Date(m[1],0,1);case"YYYY-H":return new Date(m[1],(m[2]-1)*6,1);case"H-YYYY":return new Date(m[2],(m[1]-1)*6,1);case"YYYY-Q":return new Date(m[1],(m[2]-1)*3,1);case"Q-YYYY":return new Date(m[2],(m[1]-1)*3,1);case"YYYY-M":return new Date(m[1],m[2]-1,1);case"M-YYYY":return new Date(m[2],m[1]-1,1);case"YYYY-MM-DD":return new Date(m[1],m[3]-1,m[4],m[5]||0,m[6]||0,m[7]||0);case"DD.MM.YYYY":return new Date(m[4],m[3]-1,m[1],m[5]||0,m[6]||0,m[7]||0);case"MM/DD/YYYY":return new Date(m[4],m[1]-1,m[3],m[5]||0,m[6]||0,m[7]||0)}errors++;return raw},toNum:function(d){return d.getTime()},fromNum:function(i){return new Date(i)},errors:function(){return errors},name:function(){return"date"}};return type};dw.datasource={};dw.datasource.delimited=function(opts){function loadAndParseCsv(){if(opts.url){return $.ajax({url:opts.url,method:"GET",dataType:"text"}).then(function(raw){return new DelimitedParser(opts).parse(raw)})}else if(opts.csv){var dfd=$.Deferred(),parsed=dfd.then(function(raw){return new DelimitedParser(opts).parse(raw)});dfd.resolve(opts.csv);return parsed}throw"you need to provide either an URL or CSV data."}var delimited={dataset:function(){return loadAndParseCsv()}};return delimited};var DelimitedParser=function(opts){opts=_.extend({delimiter:"auto",quoteChar:'"',skipRows:0,emptyValue:null,transpose:false,firstRowIsHeader:true,firstColumnIsHeader:true},opts);this.__delimiterPatterns=getDelimiterPatterns(opts.delimiter,opts.quoteChar);this.opts=opts};function getDelimiterPatterns(delimiter,quoteChar){return new RegExp("(\\"+delimiter+"|\\r?\\n|\\r|^)"+"(?:"+quoteChar+"([^"+quoteChar+"]*(?:"+quoteChar+'"[^'+quoteChar+"]*)*)"+quoteChar+"|"+"([^"+quoteChar+"\\"+delimiter+"\\r\\n]*))","gi")}_.extend(DelimitedParser.prototype,{parse:function(data){var me=this,opts=this.opts;me.__rawData=data;if(opts.delimiter=="auto"){opts.delimiter=me.guessDelimiter(data,opts.skipRows);me.__delimiterPatterns=getDelimiterPatterns(opts.delimiter,opts.quoteChar)}var columns=[],closure=opts.delimiter!="|"?"|":"#",arrData;data=closure+data.replace(/\s+$/g,"")+closure;function parseCSV(delimiterPattern,strData,strDelimiter){strDelimiter=strDelimiter||",";var arrData=[[]];var arrMatches=null,strMatchedValue;while(arrMatches=delimiterPattern.exec(strData)){var strMatchedDelimiter=arrMatches[1];if(strMatchedDelimiter.length&&strMatchedDelimiter!=strDelimiter){arrData.push([])}if(arrMatches[2]){strMatchedValue=arrMatches[2].replace(new RegExp('""',"g"),'"')}else{strMatchedValue=arrMatches[3]}arrData[arrData.length-1].push(strMatchedValue)}if(arrData[0][0].substr(0,1)==closure){arrData[0][0]=arrData[0][0].substr(1)}var p=arrData.length-1,q=arrData[p].length-1,r=arrData[p][q].length-1;if(arrData[p][q].substr(r)==closure){arrData[p][q]=arrData[p][q].substr(0,r)}return arrData}function transpose(arrMatrix){var a=arrMatrix,w=a.length?a.length:0,h=a[0]instanceof Array?a[0].length:0;if(h===0||w===0){return[]}var i,j,t=[];for(i=0;i<h;i++){t[i]=[];for(j=0;j<w;j++){t[i][j]=a[j][i]}}return t}function makeDataset(arrData,skipRows,emptyValue,firstRowIsHeader,firstColIsHeader){var columns=[],columnNames={},rowCount=arrData.length,columnCount=arrData[0].length,rowIndex=skipRows;var srcColumns=[];if(firstRowIsHeader){srcColumns=arrData[rowIndex];rowIndex++}for(var c=0;c<columnCount;c++){var col=_.isString(srcColumns[c])?srcColumns[c].replace(/^\s+|\s+$/g,""):"",suffix=col!==""?"":1;col=col!==""?col:"X.";while(columnNames[col+suffix]!==undefined){suffix=suffix===""?1:suffix+1}columns.push({name:col+suffix,data:[]});columnNames[col+suffix]=true}_.each(_.range(1,rowCount),function(rowIndex){_.each(columns,function(c,i){c.data.push(arrData[rowIndex][i]!==""?arrData[rowIndex][i]:emptyValue)})});columns=_.map(columns,function(c){return dw.column(c.name,c.data)});return dw.dataset(columns,{firstColumnAsLabel:firstColIsHeader})}arrData=parseCSV(this.__delimiterPatterns,data,opts.delimiter);if(opts.transpose){arrData=transpose(arrData);var t=opts.firstRowIsHeader;opts.firstRowIsHeader=opts.firstColumnIsHeader;opts.firstColumnIsHeader=t}return makeDataset(arrData,opts.skipRows,opts.emptyValue,opts.firstRowIsHeader,opts.firstColumnIsHeader)},guessDelimiter:function(strData){var maxMatchCount=0,k=-1,me=this,delimiters=["	",";","|",","];_.each(delimiters,function(delimiter,i){var regex=getDelimiterPatterns(delimiter,me.quoteChar),c=strData.match(regex).length;if(c>maxMatchCount){maxMatchCount=c;k=i}});return delimiters[k]}})}).call(this);